name: Build Optimized Alpine
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-utils libguestfs-tools linux-image-generic

      - name: Download Alpine
        run: |
          wget https://dl-cdn.alpinelinux.org/alpine/latest-stable/releases/cloud/nocloud_alpine-3.23.3-aarch64-uefi-cloudinit-metal-r0.qcow2 -O alpine.qcow2

      - name: Surgical Operation
        run: |
          export LIBGUESTFS_BACKEND=direct
          sudo guestfish -a alpine.qcow2 -i <<EOF
          glob rm /etc/runlevels/default/cloud-*
          glob rm /etc/runlevels/boot/cloud-*
          glob rm /etc/runlevels/shutdown/cloud-*
          write /etc/apk/repositories "https://dl-cdn.alpinelinux.org/alpine/latest-stable/main\nhttps://dl-cdn.alpinelinux.org/alpine/latest-stable/community"
          download /etc/passwd /tmp/passwd
          sh "sed -i 's/root:x:/root::/' /tmp/passwd"
          upload /tmp/passwd /etc/passwd
          sh "echo 'ttyAMA0' >> /etc/securetty" || write /etc/securetty "ttyAMA0"
          write /etc/resolv.conf "nameserver 8.8.8.8"
          EOF

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: alpine-docker-ready
          path: alpine.qcow2
          
